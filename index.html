<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Debian包依赖终结者</title>
</head>
<body>
<div style="position: absolute;left: 800px;top: 10px;height: 800px;width: 800px;border: 1px;overflow: auto;"><pre id="logs"></pre></div>
<h1>Debian包依赖终结者</h1>
<div>
    <label for="system-version">请选择操作系统</label>
    <select id="system-version">
        <option value="ubuntu 16.04">ubuntu 16.04</option>
    </select>
</div>
<br/>
<label for="input-select">请选择通过安装包获取依赖，还是通过自定义脚本获取依赖</label>
<form id="input-select">
    <input type="radio" name="command" value="package" checked>安装包
    <br>
    <input type="radio" name="command" value="shell">shell脚本
</form>
<br/>
<div id="package-div">
    <label for="package">请输入安装包</label>
    <input id="package" type="text" name="package">
</div>
<br/>
<div id="shell-div" hidden>
    <label for="shell">请输入自定义脚本</label>
    <textarea id="shell" rows="10" cols="80"></textarea>
</div>

<br/>
<button id="create">请求依赖包</button>
<div id="msg"></div>
<script src="https://cdn.bootcss.com/jquery/3.4.0/jquery.js"></script>
<script>
    var task_id = "";
    var input_select = "package";

    $('#input-select input').on('change', function () {
        input_select = $("#input-select input[type='radio']:checked").val();
        if (input_select == "shell") {
            $("#package-div").hide();
            $("#shell-div").show();
        } else {
            $("#package-div").show();
            $("#shell-div").hide();
        }
    });

    $('#create').click(function () {
        if (input_select == "shell") {
            if (!$('#shell').val()) {
                alert("请输入正确的包");
                return
            }
            var post_data = {
                "system_version": $('#system-version').val(),
                "command": $('#shell').val()
            };
        } else {
            if (!$('#package').val()) {
                alert("请输入正确的shell脚本");
                return
            }
            var post_data = {
                "system_version": $('#system-version').val(),
                "command": "apt-get install -d " + $('#package').val() + " -y"
            };
        }

        $.ajax({
            type: "POST",
            url: '/api/dpdt/create',
            data: JSON.stringify(post_data),
            async: true,
            success: function (data) {
                task_id = data.result.id;
                $('#msg').html("请求成功，正在构建依赖包...")
                setTimeout(get_package_status, 1000);
            },
            contentType: "application/json; charset=utf-8",
            dataType: "json"
        });
    })

    function logs(log){
        $("#logs").html(log);
        var div = document.getElementById('logs');
        div.scrollTop = div.scrollHeight;
    }

    function get_package_status() {
        $.getJSON("/api/dpdt/status?id=" + task_id, function (data) {
            if (data.status == 2000) {
                url = data.result.path;
                $('#msg').html("构建成功，链接地址：<a href='" + url + "'>TAR包</a>")
            } else if(data.status == 4001){
                logs(data.message);
                $("#logs").html(data.message);
                $('#msg').html("构建失败，请检查日志")
            }
            else {
                logs(data.result.logs);
                setTimeout(get_package_status, 1000);

            }
        });
    }
</script>
</body>
</html>
